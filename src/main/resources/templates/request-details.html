<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Детали заявки</title>
    <link th:href="@{/bootstrap/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/request-details.css}" rel="stylesheet">
</head>
<body>

<div class="container mt-3 mb-3">
    <div class="bg-white p-4 rounded shadow-sm">
        <div class="d-flex justify-content-between mb-1">
            <!-- Кнопка "Список заявок" -->
            <button type="button" onclick="window.location.href='/request/list'"
                    class="btn btn-primary d-flex align-items-center justify-content-center">
                <img src="/icons/list.svg" alt="Иконка" width="20" height="20" class="me-2">
                Заявки
            </button>

            <!-- Кнопка отмены заявки -->
            <form th:action="@{/request/cancel}" method="post"
                  th:if="${userRole == 'OPERATOR' and (requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).OPEN
                  or requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).IN_PROGRESS)}">
                <input type="hidden" name="requestId" th:value="${request.id}"/>
                <button type="submit" class="btn btn-danger d-flex align-items-center justify-content-center float-end">
                    <img src="/icons/x-circle.svg" alt="Иконка" width="20" height="20" class="me-2">
                    Отменить
                </button>
            </form>
        </div>

        <h1 class="mb-4 text-center">Детали заявки №<span th:text="${request.requestNumber}"></span></h1>

        <!-- Кнопка открытия заказ-наряда -->
        <div class="mb-3 text-center" th:if="${request.workOrder != null}">
            <form th:action="@{/work-order/details}" method="get" target="_blank">
                <input type="hidden" name="workOrderId" th:value="${request.workOrder.id}"/>
                <input type="hidden" name="viewMode" value="true"/>
                <button type="submit"
                        class="btn btn-secondary text-white d-flex align-items-center justify-content-center"
                        style="width: 170px;">
                    <img src="/icons/file.svg" alt="Иконка" width="20" height="20" class="me-2">
                    Открыть ЗН
                </button>
            </form>
        </div>

        <div class="row">
            <!-- Левая колонка -->
            <div class="col-md-6">
                <div class="info-block">
                    <h2>Общая информация</h2>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Статус заявки: </strong>
                        <span th:text="${requestStatus.description}"></span></p>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Дата создания: </strong>
                        <span th:text="${#temporals.format(request.submissionDate, 'dd.MM.yyyy HH:mm')}"></span>
                </div>

                <div class="info-block">
                    <h2>Оператор</h2>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>ФИО: </strong>
                        <span th:text="${request.operator.surname} + ' ' + ${request.operator.name} + ' ' + ${request.operator.patronymic}"></span>
                    </p>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Номер телефона: </strong>
                        <span th:text="${request.operator.phoneNumber}"></span></p>
                </div>

                <div class="info-block">
                    <h2>Клиент</h2>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>ФИО: </strong>
                        <span th:text="${request.client.surname} + ' ' + ${request.client.name} + ' ' + ${request.client.patronymic}"></span>
                    </p>

                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Номер телефона: </strong>
                        <span th:text="${request.client.phoneNumber}"></span></p>

                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Email: </strong>
                        <span th:text="${#strings.isEmpty(request.client.email) ? 'отсутствует' : request.client.email}"></span>
                    </p>
                </div>
            </div>

            <!-- Правая колонка -->
            <div class="col-md-6">
                <div class="info-block">
                    <h2>Автомобиль</h2>
                    <p class="border rounded p-2 bg-white shadow-sm">
                        <strong>Марка: </strong> <span th:text="${request.car.brand}"></span></p>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Модель: </strong>
                        <span th:text="${request.car.model}"></span></p>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>Госномер: </strong>
                        <span th:text="${request.car.stateNumber}"></span></p>
                    <p class="border rounded p-2 bg-white shadow-sm"><strong>VIN номер: </strong>
                        <span th:text="${request.car.vin}"></span></p>
                </div>

                <div class="info-block">
                    <h2>Жалобы</h2>
                    <form id="complaintForm" th:action="@{/request/update-complaint}" method="post">
                        <input type="hidden" name="requestId" th:value="${request.id}"/>
                        <textarea id="complaintField"
                                  name="complaints"
                                  class="form-control border rounded p-2 bg-white shadow-sm"
                                  style="height: 150px; width: 100%; overflow-y: auto;"
                                  th:text="${request.complaints}"
                                  readonly></textarea>

                        <!-- Кнопки редактирования и сохранения -->
                        <div class="mt-2"
                             th:if="${userRole == 'OPERATOR' and
                             (request.requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).OPEN or
                              request.requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).IN_PROGRESS)}">
                            <button type="button" class="btn btn-secondary me-2" id="editComplaintBtn" style="width: 170px">
                                <img src="/icons/pencil.svg" alt="Иконка" width="20" height="20" class="me-2">
                                Редактировать
                            </button>
                            <button type="submit" class="btn btn-success" id="saveComplaintBtn" style="display: none; width: 170px">
                                <img src="/icons/check-circle.svg" alt="Сохранить" class="form-icon me-2">
                                Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Кнопка для создания заказ-наряда -->
        <div class="d-flex justify-content-center mt-3">
            <form th:if="${userRole == 'MECHANIC' and (requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).OPEN)}"
                  th:action="@{/work-order/create}" method="post" style="display: inline;">
                <input type="hidden" name="requestId" th:value="${request.id}">
                <button type="submit" class="btn btn-success d-flex align-items-center justify-content-center"
                        style="width: 170px;">
                    <img src="/icons/tools.svg" alt="Иконка" width="20" height="20" class="me-2">
                    Начать работу
                </button>
            </form>
        </div>
    </div>
</div>

<div th:if="${alertMessage != null and !alertMessage.isEmpty()}">
    <script type="text/javascript">
        alert('[(${alertMessage})]');
    </script>
</div>

</body>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const editBtn = document.getElementById("editComplaintBtn");
        const saveBtn = document.getElementById("saveComplaintBtn");
        const complaintField = document.getElementById("complaintField");

        if (editBtn && saveBtn && complaintField) {
            editBtn.addEventListener("click", function () {
                complaintField.removeAttribute("readonly");
                complaintField.focus();
                editBtn.style.display = "none";
                saveBtn.style.display = "inline-block";
            });
        }
    });
</script>
