<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Список заказ-нарядов</title>
    <link th:href="@{/bootstrap/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/table-work-orders.css}" rel="stylesheet">
    <link th:href="@{/css/table-pagination.css}" rel="stylesheet">
    <style>
        .container-2 {
            max-width: 75%;
        }
    </style>
</head>
<body>

<div th:insert="~{/fragments/navigation.html}"></div>
<div th:replace="~{fragments/toast :: toast}"></div>

<div class="container-1 mt-3 mb-3 p-4 rounded shadow-sm main">

    <h1 class="mb-4 text-center">Список заказ-нарядов</h1>

    <div th:if="${cancellationNotice}" class="alert alert-danger mb-3" th:utext="${cancellationNotice}"></div>
    <div th:if="${dateError}" class="alert alert-danger mb-3" th:text="${dateError}"></div>


    <div class="container-2 mt-2 mb-1 p-2 bg-white shadow rounded">
        <div class="d-flex justify-content-between align-items-stretch">
            <!-- Блок фильтров -->
            <div class="filter-block" style="width: 59%;">
                <form method="get" th:action="@{/work-order/list}" class="h-100">
                    <fieldset class="border p-3 rounded h-100 d-flex flex-column">
                        <legend class="fw-bold text-dark text-center">Фильтр заказ-нарядов</legend>

                        <!-- Фильтры и кнопка очистки -->
                        <div class="d-flex flex-row align-items-end justify-content-center flex-wrap mb-3">
                            <!-- Статус -->
                            <div class="me-3 mb-2">
                                <label for="statusFilter" class="form-label">Статус:</label>
                                <select id="statusFilter" name="status" class="form-select">
                                    <option th:each="status : ${statuses}"
                                            th:value="${status}"
                                            th:text="${status.description}"
                                            th:selected="${status == selectedStatus}"></option>
                                </select>
                            </div>

                            <!-- Период -->
                            <div class="me-3 mb-2">
                                <label for="startDate" class="form-label">Период:</label>
                                <div class="d-flex align-items-center">
                                    <input type="date" id="startDate" name="startDate" th:value="${startDate}"
                                           class="form-control me-2">
                                    <span class="mx-1">-</span>
                                    <input type="date" id="endDate" name="endDate" th:value="${endDate}"
                                           class="form-control">
                                </div>
                            </div>

                            <!-- Кнопка "Очистить" -->
                            <div class="mb-2">
                                <label class="form-label d-block invisible">Очистить</label>
                                <!-- пустой лейбл для выравнивания -->
                                <button type="button"
                                        onclick="window.location.href='/work-order/list'"
                                        class="btn btn-danger d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 38px;">
                                    <img src="/icons/eraser-fill.svg" alt="Иконка" width="20" height="20">
                                </button>
                            </div>
                        </div>

                        <!-- Кнопка "Готово" -->
                        <div class="mt-auto">
                            <div class="d-flex justify-content-center">
                                <button type="submit"
                                        class="btn btn-success d-flex align-items-center justify-content-center">
                                    <img src="/icons/funnel.svg" alt="Иконка" width="20" height="20" class="me-2">
                                    Готово
                                </button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <!-- Блок поиска -->
            <div class="search-block" style="width: 39%;">
                <form method="get" th:action="@{/work-order/list}" class="h-100">
                    <fieldset class="border p-3 rounded h-100 d-flex flex-column">
                        <legend class="fw-bold text-dark text-center">Поиск заказ-наряда</legend>

                        <div class="d-flex flex-column flex-lg-row align-items-end justify-content-center mb-2">
                            <!-- № заказ-наряда -->
                            <div class="me-lg-3 mb-2 mb-lg-0">
                                <label for="searchWorkOrderId" class="form-label">№ заказ-наряда:</label>
                                <input type="text" id="searchWorkOrderId" name="searchWorkOrderId"
                                       th:value="${searchWorkOrderId}" placeholder="100"
                                       pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '')"
                                       class="form-control">
                            </div>

                            <!-- № заявки -->
                            <div class="me-lg-3 mb-2 mb-lg-0">
                                <label for="searchRequestId" class="form-label">№ заявки:</label>
                                <input type="text" id="searchRequestId" name="searchRequestId"
                                       th:value="${searchRequestId}" placeholder="200"
                                       pattern="\d*" oninput="this.value = this.value.replace(/\D/g, '')"
                                       class="form-control">
                            </div>

                            <!-- Очистить -->
                            <div class="align-self-end">
                                <button type="button" onclick="clearSearchWorkOrders()"
                                        class="btn btn-danger d-flex align-items-center justify-content-center"
                                        style="width: 50px; height: 38px;">
                                    <img src="/icons/eraser-fill.svg" alt="Иконка" width="20" height="20">
                                </button>
                            </div>
                        </div>

                        <div class="mt-auto">
                            <div class="text-muted text-center small mt-2">
                                Поиск: ЗН или Заявка (приоритет — ЗН), без фильтров
                            </div>

                            <div class="d-flex justify-content-center mt-2">
                                <button type="submit"
                                        class="btn btn-orange text-white d-flex align-items-center justify-content-center">
                                    <img src="/icons/search.svg" alt="Иконка" width="20" height="20" class="me-2"> Поиск
                                </button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>


    <!-- Контейнер для таблицы и пагинации -->
    <div class="table-container">
        <!-- Обертка для таблицы -->
        <div class="table-wrapper">
            <!-- Таблица заказ-нарядов -->
            <table id="workOrdersTable">
                <thead>
                <tr>
                    <th>№ ЗН</th>
                    <th>№ заявки</th>
                    <th>Статус</th>
                    <th>Авто</th>
                    <th>Создан</th>
                    <th>Завершен</th>
                    <th>Цена</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="workOrder : ${workOrders}"
                    th:classappend="${(workOrder.request.requestStatus == T(ru.victortikhonov.autoserviceapp.model.Request.RequestStatus).REJECTED
                     and workOrder.workOrderStatuses == T(ru.victortikhonov.autoserviceapp.model.WorkOrder.WorkOrderStatus).IN_PROGRESS)
                     ? 'canceled-in-progress ' : '' + (workOrder.id == newWorkOrderId ? 'highlight' : '')}">
                    <td th:text="${workOrder.id}"></td>
                    <td th:text="${workOrder.request.id}"></td>
                    <td th:text="${workOrder.workOrderStatuses.description}"></td>
                    <td th:text="${workOrder.request.car.brand} + ' ' + ${workOrder.request.car.model}"></td>
                    <td th:text="${#temporals.format(workOrder.startDate, 'dd-MM-yyyy HH:mm')}"></td>
                    <td th:text="${#temporals.format(workOrder.endDate, 'dd-MM-yyyy HH:mm')}"></td>
                    <td th:text="${workOrder.calculatePrice()}"></td>
                    <td class="text-center">
                        <form th:action="@{/work-order/details}" method="get" style="display: inline-block;">
                            <input type="hidden" name="workOrderId" th:value="${workOrder.id}"/>
                            <button type="submit" class="btn btn-primary p-2"
                                    style="width: 50px; height: 30px; margin: 0 auto; display: flex; justify-content: center; align-items: center;">
                                <img src="/icons/box-arrow-in-right.svg" alt="Открыть" width="20" height="20">
                            </button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${workOrders.isEmpty()}">
                    <td colspan="8">Заказ-наряды отсутствуют</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Пагинация -->
        <div class="pagination-container">
            <div class="pagination">
                <!-- Стрелка назад -->
                <span class="pagination-arrow">
                    <a th:if="${currentPage > 0}"
                       th:href="@{/work-order/list(page=${currentPage - 1}, size=${size}, status=${selectedStatus}, startDate=${startDate}, endDate=${endDate})}"
                       aria-disabled="false">
                        <img src="/icons/arrow-left-circle-fill.svg" alt="Стрелка назад" width="24" height="24"/>
                    </a>
                    <span th:if="${currentPage == 0}">
                        <img src="/icons/arrow-left-circle.svg" alt="Неактивная стрелка" width="24" height="24"/>
                    </span>
                </span>

                <!-- Текущая страница и общее количество страниц -->
                <span th:text="${currentPage + 1}"></span> из <span th:text="${totalPages}"></span>

                <!-- Стрелка вперед -->
                <span class="pagination-arrow">
                    <a th:if="${currentPage < totalPages - 1}"
                       th:href="@{/work-order/list(page=${currentPage + 1}, size=${size}, status=${selectedStatus}, startDate=${startDate}, endDate=${endDate})}"
                       aria-disabled="false">
                        <img src="/icons/arrow-right-circle-fill.svg" alt="Стрелка вперед" width="24" height="24"/>
                    </a>
                    <span th:if="${currentPage >= totalPages - 1}">
                        <img src="/icons/arrow-right-circle.svg" alt="Неактивная стрелка" width="24" height="24"/>
                    </span>
                </span>
            </div>
        </div>
    </div>
</div>

<script>
    function clearSearchWorkOrders() {
        document.getElementById('searchWorkOrderId').value = '';
        document.getElementById('searchRequestId').value = '';
        window.location.href = '/work-order/list';
    }

    function bindPaginationEvents() {
        // Перепривязываем события после обновления DOM
        document.querySelectorAll('.pagination-arrow a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                fetch(this.href)
                    .then(response => response.text())
                    .then(html => {
                        document.querySelector('.table-wrapper').innerHTML =
                            new DOMParser().parseFromString(html, 'text/html')
                                .querySelector('.table-wrapper').innerHTML;

                        document.querySelector('.pagination-container').innerHTML =
                            new DOMParser().parseFromString(html, 'text/html')
                                .querySelector('.pagination-container').innerHTML;

                        // Обновляем обработчики событий для новых элементов пагинации
                        bindPaginationEvents();
                    });
            });
        });
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', bindPaginationEvents);
</script>

</body>
</html>